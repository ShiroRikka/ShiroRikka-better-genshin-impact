name: SR_Release

on:
  # 1. æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•å’Œç‰¹æ®Šç‰ˆæœ¬å‘å¸ƒ
  workflow_dispatch:
    inputs:
      version:
        description: 'BetterGI Version (eg: 0.35.1, 0.36.5-alpha.1)'
        required: true
        type: string
      create-release:
        type: boolean
        description: 'åˆ›å»º GitHub Release'
        required: true
        default: true
  # 2. æ”¯æŒæ¨é€æ ‡ç­¾æ—¶è‡ªåŠ¨è§¦å‘ï¼Œè¿™æ˜¯æ ‡å‡†çš„è‡ªåŠ¨åŒ–å‘å¸ƒæ–¹å¼
  push:
    tags:
      - 'v*'

jobs:
  # Job 1: éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
  validate:
    runs-on: ubuntu-latest
    outputs:
      # å°†éªŒè¯åçš„ç‰ˆæœ¬å·è¾“å‡ºï¼Œä¾›å…¶ä»– Job ä½¿ç”¨
      version: ${{ steps.set-version.outputs.version }}
      is_tag: ${{ steps.set-version.outputs.is_tag }}
    steps:
      - name: Set version from input or tag
        id: set-version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶ï¼ŒéªŒè¯è¾“å…¥çš„ç‰ˆæœ¬å·æ ¼å¼
            if ! [[ "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
              echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬æ ¼å¼å¿…é¡»ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ (ä¾‹å¦‚: 1.2.3, 1.2.3-alpha, 1.2.3+build.123)"
              exit 1
            fi
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "âœ¨ æ‰‹åŠ¨è§¦å‘æ„å»ºï¼Œç‰ˆæœ¬å·ï¼š${{ github.event.inputs.version }}"
          else
            # æ¨é€æ ‡ç­¾æ—¶ï¼Œä» tag åä¸­æå–ç‰ˆæœ¬å· (å»æ‰ 'v' å‰ç¼€)
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "ğŸ·ï¸ ä» tag è§¦å‘æ„å»ºï¼Œç‰ˆæœ¬å·ï¼š${VERSION}"
          fi

  # Job 2: æ ¸å¿ƒæ„å»ºä»»åŠ¡
  build_dist:
    runs-on: windows-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.x

      - name: Update version in csproj
        run: |
          $version = '${{ needs.validate.outputs.version }}'
          (Get-Content BetterGenshinImpact/BetterGenshinImpact.csproj) -replace '<Version>.*</Version>', "<Version>$version</Version>" | Set-Content BetterGenshinImpact/BetterGenshinImpact.csproj
          echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°ä¸º $version"

      # ã€è¿ç»´å»ºè®®ã€‘åŸå·¥ä½œæµä¸­æœ‰ä¸€ä¸ªè‡ªåŠ¨æäº¤ç‰ˆæœ¬å·çš„æ­¥éª¤ã€‚
      # åœ¨ fork çš„é¡¹ç›®ä¸­ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ„å¤–æäº¤åˆ°ä½ çš„ main åˆ†æ”¯ã€‚
      # æˆ‘å·²å°†å…¶ç§»é™¤ï¼Œä»¥ä¿æŒæµç¨‹ç®€æ´å’Œå®‰å…¨ã€‚å‘å¸ƒæ—¶ç‰ˆæœ¬å·ä»…åœ¨æ„å»ºåŒ…ä¸­æ›´æ–°ã€‚

      - name: Cache NuGet packages
        uses: actions/cache@v4.3.0
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ› ï¸ Build application
        run: dotnet publish BetterGenshinImpact/BetterGenshinImpact.csproj -c Release -p:PublishProfile=FolderProfile -p:Version=${{ needs.validate.outputs.version }}

      - name: ğŸ§¹ Clean and Move Files
        run: |
          $sourceDir = ".\BetterGenshinImpact\bin\x64\Release\net8.0-windows10.0.22621.0\publish\win-x64"
          # ç§»é™¤ä¸å¿…è¦çš„æ–‡ä»¶ä»¥å‡å°ä½“ç§¯
          Get-ChildItem -Path $sourceDir -Recurse -Filter "*.lib" | Remove-Item -Force
          Get-ChildItem -Path $sourceDir -Recurse -Filter "*ffmpeg*.dll" | Remove-Item -Force
          Get-ChildItem -Path $sourceDir -Recurse -Filter "*.pdb" | Remove-Item -Force
          New-Item -Path "dist/BetterGI" -ItemType Directory -Force
          xcopy "$sourceDir\*" ".\dist\BetterGI\" /E /H /I /Y

      - name: ğŸ“¦ Generate archive
        run: |
          cd dist
          7z a "BetterGI_v${{ needs.validate.outputs.version }}.7z" BetterGI -t7z -mx=5 -mf=BCJ2 -r -y

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: BetterGI_7z
          path: dist/BetterGI_*.7z
          retention-days: 7 # æ„ä»¶ä¿ç•™7å¤©ï¼Œè¶³å¤Ÿç”¨äºå‘å¸ƒ

  # Job 3: åˆ›å»º GitHub Release
  create_release:
    # åªæœ‰åœ¨æ‰‹åŠ¨è§¦å‘å¹¶å‹¾é€‰äº†åˆ›å»ºreleaseï¼Œæˆ–è€…é€šè¿‡tagè§¦å‘æ—¶æ‰è¿è¡Œ
    if: (github.event_name == 'workflow_dispatch' && github.event.inputs.create-release == 'true') || needs.validate.outputs.is_tag == 'true'
    needs: [validate, build_dist]
    runs-on: ubuntu-latest
    permissions:
      # å¿…é¡»æˆäºˆå†™å…¥æƒé™ï¼Œæ‰èƒ½åˆ›å»ºRelease
      contents: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v6
        with:
          name: BetterGI_7z
          path: artifacts

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v2.4.2
        with:
          # ä»tagæˆ–æ‰‹åŠ¨è¾“å…¥ä¸­è·å–ç‰ˆæœ¬å·
          tag_name: v${{ needs.validate.outputs.version }}
          name: BetterGI v${{ needs.validate.outputs.version }}
          # æ ¹æ®ç‰ˆæœ¬å·æ˜¯å¦åŒ…å«'-'æ¥åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          # ä»tagè§¦å‘æ—¶ï¼Œç›´æ¥å‘å¸ƒä¸ºæ­£å¼ç‰ˆï¼›æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œå¯è‡ªè¡Œå†³å®šæ˜¯å¦ä¸ºè‰ç¨¿
          draft: ${{ needs.validate.outputs.is_tag == 'false' }}
          body: |
            å‘å¸ƒ BetterGI v${{ needs.validate.outputs.version }}
            ---
            è‡ªåŠ¨æ„å»ºå‘å¸ƒã€‚
          files: |
            artifacts/BetterGI_v*.7z
